{% extends "editor/base.html" %}
{% load static %}
{% load editor_extras %}
{% block breadcrumb %}
<nav class="breadcrumb">
  <a href="{% url 'database_list' %}">Databases</a> →
  <a href="{% url 'schema_list' db_alias=db_alias %}">{{ db_alias }}</a> →
  <a href="{% url 'table_list' db_alias=db_alias schema_name=schema_name %}">{{ schema_name }}</a> →
  {{ table_name }}
  <a href="{% url 'table_grid' db_alias=db_alias schema_name=schema_name table_name=table_name %}?refresh=1" class="refresh">Refresh</a>
</nav>
{% endblock %}
{% block content %}
<h1>{{ table_name }}</h1>
<div class="grid-toolbar">
  {% if pk_columns %}
  <button type="button" id="save-changes" disabled>Save changes</button>
  <button type="button" id="revert-changes">Revert</button>
  <button type="button" id="add-row-btn">Add row</button>
  {% endif %}
  <button type="submit" class="apply-filters" form="filter-form">Apply filters</button>
  <a href="{% url 'table_grid' db_alias=db_alias schema_name=schema_name table_name=table_name %}" class="apply-filters clear-filters{% if not has_filters %} hidden{% endif %}" id="clear-filters">Clear filters</a>
  {% if pk_columns %}
  <span id="dirty-count"></span>
  {% else %}
  <span class="read-only-msg">Read-only (table has no primary key). Add a primary key in PostgreSQL to enable editing.</span>
  {% endif %}
</div>
<form method="get" id="filter-form" class="filter-form">
  <input type="hidden" name="sort" value="{{ sort_col }}">
  <input type="hidden" name="order" value="{{ sort_order }}">
  <div class="data-grid-wrapper">
  <table class="data-grid" id="data-grid">
    <thead>
      <tr>
        {% for col in columns %}
        <th>
          <div class="column-header">
            <a href="?sort={{ col.name }}&order={% if sort_col == col.name and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% for k,v in filter_values.items %}{% if v %}&filter_{{ k }}={{ v }}{% endif %}{% endfor %}&page=1">{{ col.name }}{% if sort_col == col.name %} ({{ sort_order }}){% endif %}</a>
            <button type="button" class="filter-toggle{% if filter_values|get_item:col.name %} active{% endif %}" title="Filter this column" data-column="{{ col.name }}">
              <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M1.5 1.5h13L9 7v5.5l-2 1.5V7z"/></svg>
            </button>
          </div>
          <div class="filter-wrapper" style="display: none;">
            <input type="text" name="filter_{{ col.name }}" value="{{ filter_values|get_item:col.name }}" placeholder="Filter..." class="filter-input" data-column="{{ col.name }}">
          </div>
        </th>
        {% endfor %}
        {% if pk_columns %}
        <th class="actions-header">Actions</th>
        {% endif %}
      </tr>
    </thead>
  <tbody>
    {% for row in rows %}
    <tr data-row-index="{{ forloop.counter0 }}" data-pk="{{ row|pk_json:pk_columns }}">
      {% for col in columns %}
      <td data-column="{{ col.name }}" data-type="{{ col.data_type }}" data-original="{{ row|input_value_for_column:col|force_escape }}">
        <span class="cell-raw" aria-hidden="true" style="display:none">{{ row|get_item:col.name }}</span>
        <span class="cell-display">{{ row|get_item:col.name }}</span>
        {% if col|input_type_for_column == "checkbox" %}
        <input type="checkbox" class="cell-edit" {% if row|input_value_for_column:col == 'true' %}checked{% endif %} style="display:none">
        {% else %}
        <input type="{{ col|input_type_for_column }}" class="cell-edit" value="{{ row|input_value_for_column:col|force_escape }}" style="display:none">
        {% if col|is_datetime_column %}
        <button type="button" class="cell-now" style="display:none" title="Fill with current date/time">Now</button>
        {% endif %}
        {% endif %}
      </td>
      {% endfor %}
      {% if pk_columns %}
      <td class="actions-cell">
        <button type="button" class="delete-row" title="Hard delete row">Delete</button>
      </td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
  </table>
  </div>
</form>
<p class="pagination">
  {% if page.has_previous %}<a href="?page={{ page.previous_page_number }}&sort={{ sort_col }}&order={{ sort_order }}{% for k,v in filter_values.items %}{% if v %}&filter_{{ k }}={{ v }}{% endif %}{% endfor %}">Previous</a>{% endif %}
  Page {{ page.number }} of {{ page.paginator.num_pages }} ({{ page.paginator.count }} rows)
  {% if page.has_next %}<a href="?page={{ page.next_page_number }}&sort={{ sort_col }}&order={{ sort_order }}{% for k,v in filter_values.items %}{% if v %}&filter_{{ k }}={{ v }}{% endif %}{% endfor %}">Next</a>{% endif %}
</p>
{% if pk_columns %}
<script id="edit-grid-config" type="application/json">{{ config_json|safe }}</script>
{% endif %}
<script src="{% static 'editor/js/grid.js' %}"></script>
{% endblock %}
